name: Bootstrap test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  bootstrap-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run bootstrap test
        run: |
          set -euo pipefail
          chmod +x scripts/test-bootstrap.sh
          bash scripts/test-bootstrap.sh

      - name: Smoke test dry-run JSON emit
        run: |
          set -euo pipefail
          TMPDIR=$(mktemp -d)
          chmod +x scripts/kiro-spec-bootstrap.sh
          bash scripts/kiro-spec-bootstrap.sh --target "$TMPDIR" --feature ci-test --subroot app --dry-run --yes --emit-json "$TMPDIR/actions.json"
          if [[ ! -f "$TMPDIR/actions.json" ]]; then
            echo "Missing actions.json"; exit 1
          fi
          if ! grep -q 'write-config' "$TMPDIR/actions.json"; then
            echo "actions.json missing expected entry"; exit 1
          fi
